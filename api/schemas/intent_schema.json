{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Natural Language Query Intent Schema",
  "description": "Strict intent schema for AI-driven natural language data exploration. The AI must output intent (not SQL) that will be validated and translated to safe SQL.",
  "version": "1.0.0",
  "type": "object",
  "required": ["table", "fields"],
  "properties": {
    "table": {
      "type": "string",
      "description": "Target table name (must exist in schema contract)",
      "enum": ["students"],
      "pattern": "^[a-z_][a-z0-9_]*$"
    },
    "fields": {
      "type": "array",
      "description": "Columns to retrieve. Use ['*'] for all columns.",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["column"],
        "properties": {
          "column": {
            "type": "string",
            "description": "Column name from the schema (must be valid column)",
            "enum": ["id", "name", "date_of_birth", "gender", "qpa", "country", "*"],
            "pattern": "^[a-z_][a-z0-9_]*$|^\\*$"
          },
          "alias": {
            "type": "string",
            "description": "Optional alias for the column in results",
            "pattern": "^[a-z_][a-z0-9_]*$"
          }
        }
      },
      "uniqueItems": true
    },
    "filters": {
      "type": "array",
      "description": "WHERE clause conditions (AND logic between filters)",
      "items": {
        "type": "object",
        "required": ["column", "operator", "value"],
        "properties": {
          "column": {
            "type": "string",
            "description": "Column to filter on",
            "enum": ["id", "name", "date_of_birth", "gender", "qpa", "country"]
          },
          "operator": {
            "type": "string",
            "description": "Comparison operator",
            "enum": ["=", "!=", ">", ">=", "<", "<=", "LIKE", "IN", "BETWEEN", "IS NULL", "IS NOT NULL"]
          },
          "value": {
            "description": "Value(s) to compare. Use array for IN/BETWEEN, null for IS NULL/IS NOT NULL",
            "oneOf": [
              {"type": "string"},
              {"type": "number"},
              {"type": "boolean"},
              {"type": "null"},
              {
                "type": "array",
                "items": {
                  "oneOf": [
                    {"type": "string"},
                    {"type": "number"}
                  ]
                }
              }
            ]
          },
          "logicalOperator": {
            "type": "string",
            "description": "Logical operator to combine with next filter (default: AND)",
            "enum": ["AND", "OR"],
            "default": "AND"
          }
        }
      }
    },
    "aggregations": {
      "type": "array",
      "description": "Aggregate functions to apply",
      "items": {
        "type": "object",
        "required": ["function", "column"],
        "properties": {
          "function": {
            "type": "string",
            "description": "Aggregate function name",
            "enum": ["COUNT", "SUM", "AVG", "MIN", "MAX", "COUNT_DISTINCT"]
          },
          "column": {
            "type": "string",
            "description": "Column to aggregate (use '*' for COUNT only)",
            "pattern": "^[a-z_][a-z0-9_]*$|^\\*$"
          },
          "alias": {
            "type": "string",
            "description": "Alias for aggregate result",
            "pattern": "^[a-z_][a-z0-9_]*$"
          }
        }
      }
    },
    "groupBy": {
      "type": "array",
      "description": "Columns to group results by (required when using aggregations)",
      "items": {
        "type": "string",
        "enum": ["id", "name", "date_of_birth", "gender", "qpa", "country"],
        "pattern": "^[a-z_][a-z0-9_]*$"
      },
      "uniqueItems": true
    },
    "orderBy": {
      "type": "array",
      "description": "Columns to sort results by",
      "items": {
        "type": "object",
        "required": ["column"],
        "properties": {
          "column": {
            "type": "string",
            "description": "Column to sort by (can be column name or aggregate alias)",
            "pattern": "^[a-z_][a-z0-9_]*$"
          },
          "direction": {
            "type": "string",
            "description": "Sort direction",
            "enum": ["ASC", "DESC"],
            "default": "ASC"
          }
        }
      }
    },
    "limit": {
      "type": "integer",
      "description": "Maximum number of rows to return",
      "minimum": 1,
      "maximum": 1000,
      "default": 100
    },
    "offset": {
      "type": "integer",
      "description": "Number of rows to skip (for pagination)",
      "minimum": 0,
      "default": 0
    },
    "distinct": {
      "type": "boolean",
      "description": "Whether to return only distinct rows",
      "default": false
    }
  },
  "definitions": {
    "validationRules": {
      "description": "Validation rules that MUST be enforced before SQL generation",
      "rules": [
        {
          "id": "VR-001",
          "rule": "Table name must exist in schema contract",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-002",
          "rule": "All column names must exist in the specified table schema",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-003",
          "rule": "Aggregations require groupBy unless aggregating all rows",
          "severity": "error",
          "action": "Reject intent or auto-add groupBy"
        },
        {
          "id": "VR-004",
          "rule": "When groupBy is used, all non-aggregated fields must be in groupBy",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-005",
          "rule": "Filter operators must match column data types (e.g., no LIKE on integers)",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-006",
          "rule": "BETWEEN operator requires array value with exactly 2 elements",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-007",
          "rule": "IN operator requires array value with at least 1 element",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-008",
          "rule": "IS NULL / IS NOT NULL must have null value",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-009",
          "rule": "Limit must be between 1 and 1000",
          "severity": "error",
          "action": "Reject intent or cap at 1000"
        },
        {
          "id": "VR-010",
          "rule": "Offset must be >= 0",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-011",
          "rule": "Column aliases must be unique within the same query",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-012",
          "rule": "COUNT(*) is the only aggregate that allows '*' as column",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-013",
          "rule": "Numeric aggregations (SUM, AVG) require numeric columns (qpa, id)",
          "severity": "error",
          "action": "Reject intent"
        },
        {
          "id": "VR-014",
          "rule": "orderBy columns must exist in fields or aggregations",
          "severity": "warning",
          "action": "Allow but warn user"
        },
        {
          "id": "VR-015",
          "rule": "No fields array should contain both '*' and specific columns",
          "severity": "error",
          "action": "Reject intent"
        }
      ]
    },
    "disallowedPatterns": {
      "description": "Patterns that MUST NEVER appear in intent output",
      "patterns": [
        {
          "id": "DP-001",
          "pattern": "SQL keywords in values (e.g., DROP, DELETE, UPDATE, INSERT, TRUNCATE, ALTER)",
          "reason": "Prevents SQL injection attempts",
          "detection": "Scan all string values for SQL keywords",
          "action": "Reject intent immediately"
        },
        {
          "id": "DP-002",
          "pattern": "SQL comments (-- or /* */)",
          "reason": "Prevents comment-based injection",
          "detection": "Check for comment patterns in all string values",
          "action": "Reject intent immediately"
        },
        {
          "id": "DP-003",
          "pattern": "Multiple statements (semicolons in values)",
          "reason": "Prevents statement chaining",
          "detection": "Check for semicolons in string values",
          "action": "Reject intent immediately"
        },
        {
          "id": "DP-004",
          "pattern": "Subqueries or nested SELECT",
          "reason": "Intent schema does not support subqueries",
          "detection": "No 'subquery' or nested intent objects allowed",
          "action": "Reject intent"
        },
        {
          "id": "DP-005",
          "pattern": "UNION, JOIN, or multi-table operations",
          "reason": "Single-table queries only",
          "detection": "Check for multiple table references",
          "action": "Reject intent"
        },
        {
          "id": "DP-006",
          "pattern": "Function calls in column names or values (except allowed aggregates)",
          "reason": "Prevents arbitrary function execution",
          "detection": "Check for parentheses in column names",
          "action": "Reject intent"
        },
        {
          "id": "DP-007",
          "pattern": "Wildcards in column names (except '*' for all columns)",
          "reason": "Column names must be explicit",
          "detection": "Check for % or _ in column names",
          "action": "Reject intent"
        },
        {
          "id": "DP-008",
          "pattern": "Non-ASCII characters (unless explicitly allowed)",
          "reason": "Prevents encoding-based attacks",
          "detection": "Validate character set",
          "action": "Sanitize or reject"
        },
        {
          "id": "DP-009",
          "pattern": "Extremely long values (>1000 characters)",
          "reason": "Prevents buffer overflow or performance issues",
          "detection": "Check string length",
          "action": "Reject intent"
        },
        {
          "id": "DP-010",
          "pattern": "Null bytes or control characters",
          "reason": "Prevents injection and encoding issues",
          "detection": "Scan for \\x00 and control chars",
          "action": "Reject intent"
        }
      ]
    },
    "typeValidation": {
      "description": "Type-specific validation for column data types",
      "columnTypes": {
        "id": {
          "type": "integer",
          "allowedOperators": ["=", "!=", ">", ">=", "<", "<=", "IN", "BETWEEN"],
          "allowedAggregates": ["COUNT", "SUM", "AVG", "MIN", "MAX"]
        },
        "name": {
          "type": "string",
          "allowedOperators": ["=", "!=", "LIKE", "IN", "IS NULL", "IS NOT NULL"],
          "allowedAggregates": ["COUNT", "MIN", "MAX", "COUNT_DISTINCT"]
        },
        "date_of_birth": {
          "type": "date",
          "allowedOperators": ["=", "!=", ">", ">=", "<", "<=", "BETWEEN", "IS NULL", "IS NOT NULL"],
          "allowedAggregates": ["COUNT", "MIN", "MAX", "COUNT_DISTINCT"],
          "format": "YYYY-MM-DD"
        },
        "gender": {
          "type": "string",
          "allowedOperators": ["=", "!=", "IN", "IS NULL", "IS NOT NULL"],
          "allowedAggregates": ["COUNT", "COUNT_DISTINCT"]
        },
        "qpa": {
          "type": "real",
          "allowedOperators": ["=", "!=", ">", ">=", "<", "<=", "BETWEEN", "IS NULL", "IS NOT NULL"],
          "allowedAggregates": ["COUNT", "SUM", "AVG", "MIN", "MAX"],
          "range": [0.0, 4.0]
        },
        "country": {
          "type": "string",
          "allowedOperators": ["=", "!=", "LIKE", "IN", "IS NULL", "IS NOT NULL"],
          "allowedAggregates": ["COUNT", "COUNT_DISTINCT"]
        }
      }
    }
  },
  "examples": {
    "simpleQuery": {
      "description": "Get all students from Canada",
      "intent": {
        "table": "students",
        "fields": [
          {"column": "name"},
          {"column": "qpa"},
          {"column": "country"}
        ],
        "filters": [
          {
            "column": "country",
            "operator": "=",
            "value": "Canada"
          }
        ],
        "limit": 100
      }
    },
    "aggregationQuery": {
      "description": "Average QPA by country",
      "intent": {
        "table": "students",
        "fields": [
          {"column": "country"}
        ],
        "aggregations": [
          {
            "function": "AVG",
            "column": "qpa",
            "alias": "average_qpa"
          },
          {
            "function": "COUNT",
            "column": "*",
            "alias": "student_count"
          }
        ],
        "groupBy": ["country"],
        "orderBy": [
          {
            "column": "average_qpa",
            "direction": "DESC"
          }
        ],
        "limit": 50
      }
    },
    "complexFilters": {
      "description": "Students with high QPA from specific countries",
      "intent": {
        "table": "students",
        "fields": [
          {"column": "name"},
          {"column": "qpa"},
          {"column": "country"},
          {"column": "gender"}
        ],
        "filters": [
          {
            "column": "qpa",
            "operator": ">=",
            "value": 3.5,
            "logicalOperator": "AND"
          },
          {
            "column": "country",
            "operator": "IN",
            "value": ["Canada", "USA", "UK"]
          }
        ],
        "orderBy": [
          {
            "column": "qpa",
            "direction": "DESC"
          }
        ],
        "limit": 20
      }
    }
  },
  "metadata": {
    "generatedAt": "2026-01-23",
    "purpose": "Intent schema for AI-driven natural language to query translation",
    "security": "This intent schema enforces strict validation to prevent SQL injection and ensure safe query generation",
    "workflow": [
      "1. AI receives natural language query from user",
      "2. AI outputs structured intent JSON conforming to this schema",
      "3. Backend validates intent against validation rules",
      "4. Backend checks for disallowed patterns",
      "5. Backend translates valid intent to parameterized SQL",
      "6. Backend executes SQL safely (readonly mode)",
      "7. Results returned to user"
    ]
  }
}
